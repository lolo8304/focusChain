import { Template } from 'meteor/templating';
import { ReactiveVar } from 'meteor/reactive-var';

import './main.html';

Template.hello.onCreated(function helloOnCreated() {
  // counter starts at 0
	this.counter = new ReactiveVar(0);
	
	if (typeof web3 !== 'undefined') {
		web3 = new Web3(web3.currentProvider);
	} else {
		// set the provider you want from Web3.providers
		web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8101"));		
	}
	
	var carContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"damageState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[],"name":"supply","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"model","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"customer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"producer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"ccm","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"details","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"insuranceId","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"chassisNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"exmatriculate","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"_customer","type":"address"}],"name":"sell","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"price","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_chassisNo","type":"string"},{"name":"_assemblyLine","type":"string"}],"name":"produce","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"policyNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"_insuranceId","type":"string"},{"name":"_policyNo","type":"string"}],"name":"admit","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"creationTime","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"holder","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"deliver","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"assemblyLine","outputs":[{"name":"","type":"string"}],"type":"function"},{"inputs":[{"name":"_model","type":"string"},{"name":"_ccm","type":"uint256"},{"name":"_price","type":"uint256"},{"name":"_details","type":"string"},{"name":"_producer","type":"address"},{"name":"_customer","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_modell","type":"string"},{"indexed":false,"name":"_ccm","type":"uint256"},{"indexed":false,"name":"_price","type":"uint256"}],"name":"Ordered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"chassisNo","type":"string"}],"name":"Produced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_garage","type":"address"}],"name":"Supplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"}],"name":"Delivered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_insuranceId","type":"string"},{"indexed":false,"name":"_policyNo","type":"string"}],"name":"Admitted","type":"event"}]);
	
	if(!web3.isConnected()) {
		console.log("NO - not connected");
	} else {
		console.log("YES - Connected to local geth");
		var contractAddress = localStorage.getItem("contract");
		if (!contractAddress) {
			console.log("NEW CONTRACT");
									
			var _model = "Kia" ;
			var _ccm = 1 ;
			var _price = 10000 ;
			var _details = "nice car"  ;
			var _producer = "0x7690268bBf44665f223F69026207Be2BB8dD8764" ;
		
			
			var car = carContract.new(
				_model,
				_ccm,
				_price,
				_details,
				_producer,
				{
					from: web3.eth.accounts[0], 
					data: '60606040526000600060006101000a81548160ff021916908302179055506000600060016101000a81548160ff02191690830217905550426001600050556040516118a33803806118a3833981016040528080518201919060200180519060200190919080519060200190919080518201919060200180519060200190919080519060200190919050505b8560066000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100d957805160ff191683800117855561010a565b8280016001018555821561010a579182015b828111156101095782518260005055916020019190600101906100eb565b5b5090506101359190610117565b808211156101315760008181506000905550600101610117565b5090565b505084600860005081905550836007600050819055508260096000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061019a57805160ff19168380011785556101cb565b828001600101855582156101cb579182015b828111156101ca5782518260005055916020019190600101906101ac565b5b5090506101f691906101d8565b808211156101f257600081815060009055506001016101d8565b5090565b505081600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555080600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507fac9f1183a611a4397dfa056e1c64978ae62e6ce7cb5c0a4ff413d55cb810de59600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166006600050600860005054600760005054604051808673ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff168152602001806020018481526020018381526020018281038252858181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156103be5780601f10610393576101008083540402835291602001916103be565b820191906000526020600020905b8154815290600101906020018083116103a157829003601f168201915b5050965050505050505060405180910390a15b5050505050506114be806103e56000396000f360606040523615610124576000357c01000000000000000000000000000000000000000000000000000000009004806303289be414610131578063047fc9aa146101545780630ad9d052146101635780631865c57d146101de5780632804b2c014610201578063376126721461023a5780633a16e5cf14610273578063565974d3146102965780635acf77b0146103115780636c56e4531461038c5780636ec1c7ac146104075780638da5cb5b1461041657806394b6f9d41461044f578063a035b1fe14610467578063a86af0711461048a578063c19d93fb14610527578063d7516d0d1461054a578063d7c63d12146105c5578063d8270dce14610662578063e534155d14610685578063fd3e50a7146106be578063fdca9988146106cd57610124565b61012f5b610002565b565b005b61013e6004805050610748565b6040518082815260200191505060405180910390f35b610161600480505061075b565b005b6101706004805050610832565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156101d05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101eb60048050506108d3565b6040518082815260200191505060405180910390f35b61020e60048050506108ef565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102476004805050610915565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610280600480505061093b565b6040518082815260200191505060405180910390f35b6102a36004805050610944565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103035780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61031e60048050506109e5565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f16801561037e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6103996004805050610a86565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103f95780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6104146004805050610b27565b005b6104236004805050610cc3565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6104656004808035906020019091905050610ce9565b005b6104746004805050610d79565b6040518082815260200191505060405180910390f35b6105256004808035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610d82565b005b6105346004805050610e5b565b6040518082815260200191505060405180910390f35b6105576004805050610e6e565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156105b75780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6106606004808035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610f0f565b005b61066f600480505061124b565b6040518082815260200191505060405180910390f35b6106926004805050611254565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6106cb600480505061127a565b005b6106da60048050506113f0565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f16801561073a5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b600060019054906101000a900460ff1681565b6000600060009054906101000a900460ff1614801561078257506001600160005054014210155b156107905761078f611491565b5b6001600060009054906101000a900460ff161480156107b757506001600160005054014210155b156107c5576107c4611491565b5b6002600060009054906101000a900460ff161480156107ec57506001600160005054014210155b156107fa576107f9611491565b5b6003600060009054906101000a900460ff1614801561082157506001600160005054014210155b1561082f5761082e611491565b5b5b565b60066000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108cb5780601f106108a0576101008083540402835291602001916108cb565b820191906000526020600020905b8154815290600101906020018083116108ae57829003601f168201915b505050505081565b6000600060009054906101000a900460ff1690506108ec565b90565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60086000505481565b60096000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109dd5780601f106109b2576101008083540402835291602001916109dd565b820191906000526020600020905b8154815290600101906020018083116109c057829003601f168201915b505050505081565b600c6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a7e5780601f10610a5357610100808354040283529160200191610a7e565b820191906000526020600020905b815481529060010190602001808311610a6157829003601f168201915b505050505081565b600a6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b1f5780601f10610af457610100808354040283529160200191610b1f565b820191906000526020600020905b815481529060010190602001808311610b0257829003601f168201915b505050505081565b6020604051908101604052806000815260200150600c6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610b8957805160ff1916838001178555610bba565b82800160010185558215610bba579182015b82811115610bb9578251826000505591602001919060010190610b9b565b5b509050610be59190610bc7565b80821115610be15760008181506000905550600101610bc7565b5090565b50506020604051908101604052806000815260200150600d6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610c4957805160ff1916838001178555610c7a565b82800160010185558215610c7a579182015b82811115610c79578251826000505591602001919060010190610c5b565b5b509050610ca59190610c87565b80821115610ca15760008181506000905550600101610c87565b5090565b50506006600060006101000a81548160ff021916908302179055505b565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6004600060009054906101000a900460ff161415610d0657610002565b6005600060006101000a81548160ff0219169083021790555080600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555080600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b50565b60076000505481565b6000600060009054906101000a900460ff16148015610da957506001600160005054014210155b15610db757610db6611491565b5b6001600060009054906101000a900460ff16148015610dde57506001600160005054014210155b15610dec57610deb611491565b5b6002600060009054906101000a900460ff16148015610e1357506001600160005054014210155b15610e2157610e20611491565b5b6003600060009054906101000a900460ff16148015610e4857506001600160005054014210155b15610e5657610e55611491565b5b5b5050565b600060009054906101000a900460ff1681565b600d6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f075780601f10610edc57610100808354040283529160200191610f07565b820191906000526020600020905b815481529060010190602001808311610eea57829003601f168201915b505050505081565b6002600060009054906101000a900460ff16141580610f3e57506006600060009054906101000a900460ff1614155b15610f4857610002565b6003600060006101000a81548160ff0219169083021790555081600c6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610fb057805160ff1916838001178555610fe1565b82800160010185558215610fe1579182015b82811115610fe0578251826000505591602001919060010190610fc2565b5b50905061100c9190610fee565b808211156110085760008181506000905550600101610fee565b5090565b505080600d6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061105d57805160ff191683800117855561108e565b8280016001018555821561108e579182015b8281111561108d57825182600050559160200191906001019061106f565b5b5090506110b9919061109b565b808211156110b5576000818150600090555060010161109b565b5090565b50507fea04ec6e2a3a8ca63f7562feddb67ae3ee02df116a76976b29ce621d89d2a287600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600c600050600d600050604051808473ffffffffffffffffffffffffffffffffffffffff16815260200180602001806020018381038352858181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156111b25780601f10611187576101008083540402835291602001916111b2565b820191906000526020600020905b81548152906001019060200180831161119557829003601f168201915b50508381038252848181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156112355780601f1061120a57610100808354040283529160200191611235565b820191906000526020600020905b81548152906001019060200180831161121857829003601f168201915b50509550505050505060405180910390a15b5050565b60016000505481565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6003600060009054906101000a900460ff161415806112a957506005600060009054906101000a900460ff1614155b156112b357610002565b3373ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561130f57610002565b6004600060006101000a81548160ff0219169083021790555033600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507ffedf826d9b4a1fe2a221dc900337fc72788ddb41c7ae6600c110ca2858365da4600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b565b600b6000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156114895780601f1061145e57610100808354040283529160200191611489565b820191906000526020600020905b81548152906001019060200180831161146c57829003601f168201915b505050505081565b6001600060009054906101000a900460ff1601600060006101000a81548160ff021916908302179055505b56', 
					gas: 3000000
				}, function(e, contract){
					console.log(e, contract);
					if (typeof contract.address != 'undefined') {
						console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
						localStorage.setItem("contract", contract.address);
						var contractInstance = carContract.at(contractAddress);
					}
				}); 
		} else {
			console.log(contractAddress);
			web3.eth.defaultAccount = web3.eth.accounts[0];
			var contractInstance = carContract.at(contractAddress);
			//var result = contractInstance.order("123", "1");
			//console.log("RESULT Order Function");
			//console.log(result);
		}
		
		var event = contractInstance.Ordered().watch(function(error, result){
			if (!error) {
				console.log("EVENT FIRED");
				console.log(result);
			} else {
				console.log("EVENT ERROR");
				console.log(error);
			}
		});
			
	}  
});

Template.hello.helpers({
  counter() {
    return Template.instance().counter.get();
  },
});

Template.hello.events({
  'click button'(event, instance) {
    // increment the counter when button is clicked
    instance.counter.set(instance.counter.get() + 1);
  },
});
