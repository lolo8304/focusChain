import { Template } from 'meteor/templating';
import { ReactiveVar } from 'meteor/reactive-var';

import './main.html';

/**
 * if console writes "web3 is not defined", execute this command before starting meteor:
 * meteor add ethereum:web3$
 */
var carContract;

Template.hello.onCreated(function helloOnCreated() {
  // counter starts at 0
	this.counter = new ReactiveVar(0);
	
	if (typeof web3 !== 'undefined') {
		web3 = new Web3(web3.currentProvider);
	} else {
		// set the provider you want from Web3.providers
		web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8101"));
	}

	
	if(!web3.isConnected()) {
		console.log("NO - not connected");
	} else {
		console.log("YES - Connected to local geth");
		var contractAddress = localStorage.getItem("contract");
		if (contractAddress) {
			web3.eth.defaultAccount = web3.eth.accounts[0];
			carContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"damageState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[],"name":"supply","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"model","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"customer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"producer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"ccm","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"details","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"insuranceId","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"chassisNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"exmatriculate","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"_customer","type":"address"}],"name":"sell","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"price","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"_chassisNo","type":"string"},{"name":"_assemblyLine","type":"string"}],"name":"produce","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"policyNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"_insuranceId","type":"string"},{"name":"_policyNo","type":"string"}],"name":"admit","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"creationTime","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"holder","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"deliver","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"assemblyLine","outputs":[{"name":"","type":"string"}],"type":"function"},{"inputs":[{"name":"_model","type":"string"},{"name":"_ccm","type":"uint8"},{"name":"_price","type":"uint8"},{"name":"_details","type":"string"},{"name":"_producer","type":"address"},{"name":"_customer","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_modell","type":"string"},{"indexed":false,"name":"_ccm","type":"uint8"},{"indexed":false,"name":"_price","type":"uint8"}],"name":"Ordered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"chassisNo","type":"string"}],"name":"Produced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_garage","type":"address"}],"name":"Supplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"}],"name":"Delivered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_insuranceId","type":"string"},{"indexed":false,"name":"_policyNo","type":"string"}],"name":"Admitted","type":"event"}]);
			var contractInstance = carContract.at(contractAddress);

			var event = contractInstance.Produced().watch(function(error, result){
			if (!error) {
				console.log("EVENT FIRED");
				console.log(result);
			} else {
				console.log("EVENT ERROR");
				console.log(error);
			}
			});	
			
		}
			
		

	}


	var contractID = "0x33AC1865B84F768e708B8FAA4eac1d333F84bE9d";

	var filter = web3.eth.filter({
		fromBlock:0,
	 	toBlock: 'latest',
	 	address: contractID
	 /*,
		'topics':['0x' + web3.sha3('Produced(address,address,string)')  ]
		*/
	});
	filter.watch(function(error, result) {
		if(!error) {
			console.log("watch RESULT "+result);
	 	} else {
			console.log("watch ERROR "+error)
	 	}
	})

});

Template.hello.helpers({
	
});

Template.hello.events({
	'click button'(event, instance) {
		if (event.currentTarget.id == "deploy") {
			deployContract(instance);
		}
		if (event.currentTarget.id == "produce") {
			var contractInstance = carContract.at(localStorage.getItem("contract"));
			var result = contractInstance.produce("123", "BMW Munich");
		}
	},
});

function deployContract(instance) {
	console.log("Deploying contract...");
	var _model = "Kia" ;
	var _ccm = 1 ;
	var _price = 10000 ;
	var _details = "nice car"  ;
	var _producer = "0x7690268bBf44665f223F69026207Be2BB8dD8764" ;

	carContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"damageState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[],"name":"supply","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"model","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"getState","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"customer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"producer","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[],"name":"ccm","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"details","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"insuranceId","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"chassisNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[],"name":"exmatriculate","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"_customer","type":"address"}],"name":"sell","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"price","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"_chassisNo","type":"string"},{"name":"_assemblyLine","type":"string"}],"name":"produce","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"policyNo","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"_insuranceId","type":"string"},{"name":"_policyNo","type":"string"}],"name":"admit","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"creationTime","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"holder","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"deliver","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"assemblyLine","outputs":[{"name":"","type":"string"}],"type":"function"},{"inputs":[{"name":"_model","type":"string"},{"name":"_ccm","type":"uint8"},{"name":"_price","type":"uint8"},{"name":"_details","type":"string"},{"name":"_producer","type":"address"},{"name":"_customer","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_modell","type":"string"},{"indexed":false,"name":"_ccm","type":"uint8"},{"indexed":false,"name":"_price","type":"uint8"}],"name":"Ordered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_producer","type":"address"},{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"chassisNo","type":"string"}],"name":"Produced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_garage","type":"address"}],"name":"Supplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"}],"name":"Delivered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_customer","type":"address"},{"indexed":false,"name":"_insuranceId","type":"string"},{"indexed":false,"name":"_policyNo","type":"string"}],"name":"Admitted","type":"event"}]);
	var car = carContract.new(
		_model,
		_ccm,
		_price,
		_details,
		_producer,
		{
			from: web3.eth.accounts[0],
			data: '60606040526000600060006101000a81548160ff021916908302179055506000600060016101000a81548160ff0219169083021790555042600160005055604051611a8c380380611a8c833981016040528080518201919060200180519060200190919080519060200190919080518201919060200180519060200190919080519060200190919050505b8560066000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100d957805160ff191683800117855561010a565b8280016001018555821561010a579182015b828111156101095782518260005055916020019190600101906100eb565b5b5090506101359190610117565b808211156101315760008181506000905550600101610117565b5090565b505084600760016101000a81548160ff0219169083021790555083600760006101000a81548160ff021916908302179055508260086000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101b657805160ff19168380011785556101e7565b828001600101855582156101e7579182015b828111156101e65782518260005055916020019190600101906101c8565b5b50905061021291906101f4565b8082111561020e57600081815060009055506001016101f4565b5090565b505081600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555080600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507feef352d7671e11c434ca17587dfe1aba2003d9a83f99df6741f07f6ee24aeaa8600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166006600050600760019054906101000a900460ff16600760009054906101000a900460ff16604051808673ffffffffffffffffffffffffffffffffffffffff1681526020018573ffffffffffffffffffffffffffffffffffffffff168152602001806020018460ff1681526020018360ff1681526020018281038252858181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156103f45780601f106103c9576101008083540402835291602001916103f4565b820191906000526020600020905b8154815290600101906020018083116103d757829003601f168201915b5050965050505050505060405180910390a15b5050505050506116718061041b6000396000f360606040523615610124576000357c01000000000000000000000000000000000000000000000000000000009004806303289be414610131578063047fc9aa146101545780630ad9d052146101635780631865c57d146101de5780632804b2c014610201578063376126721461023a5780633a16e5cf14610273578063565974d3146102995780635acf77b0146103145780636c56e4531461038f5780636ec1c7ac1461040a5780638da5cb5b1461041957806394b6f9d414610452578063a035b1fe1461046a578063a86af07114610490578063c19d93fb1461052d578063d7516d0d14610550578063d7c63d12146105cb578063d8270dce14610668578063e534155d1461068b578063fd3e50a7146106c4578063fdca9988146106d357610124565b61012f5b610002565b565b005b61013e600480505061074e565b6040518082815260200191505060405180910390f35b6101616004805050610761565b005b61017060048050506107f5565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156101d05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101eb6004805050610896565b6040518082815260200191505060405180910390f35b61020e60048050506108b2565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61024760048050506108d8565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61028060048050506108fe565b604051808260ff16815260200191505060405180910390f35b6102a66004805050610911565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103065780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61032160048050506109b2565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103815780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61039c6004805050610a53565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156103fc5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6104176004805050610af4565b005b6104266004805050610c90565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6104686004808035906020019091905050610cb6565b005b6104776004805050610d46565b604051808260ff16815260200191505060405180910390f35b61052b6004808035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610d59565b005b61053a6004805050611039565b6040518082815260200191505060405180910390f35b61055d600480505061104c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156105bd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6106666004808035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019082018035906020019191908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509090919050506110ed565b005b610675600480505061142a565b6040518082815260200191505060405180910390f35b6106986004805050611433565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6106d16004805050611459565b005b6106e060048050506115d0565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156107405780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b600060019054906101000a900460ff1681565b33600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506002600060006101000a81548160ff021916908302179055507f6663c4b4f37934bad95a7e7828d7613470512e596e6278df939ba459ae7e0f6333604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b565b60066000508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561088e5780601f106108635761010080835404028352916020019161088e565b820191906000526020600020905b81548152906001019060200180831161087157829003601f168201915b505050505081565b6000600060009054906101000a900460ff1690506108af565b90565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600760019054906101000a900460ff1681565b60086000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109aa5780601f1061097f576101008083540402835291602001916109aa565b820191906000526020600020905b81548152906001019060200180831161098d57829003601f168201915b505050505081565b600b6000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a4b5780601f10610a2057610100808354040283529160200191610a4b565b820191906000526020600020905b815481529060010190602001808311610a2e57829003601f168201915b505050505081565b60096000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610aec5780601f10610ac157610100808354040283529160200191610aec565b820191906000526020600020905b815481529060010190602001808311610acf57829003601f168201915b505050505081565b6020604051908101604052806000815260200150600b6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610b5657805160ff1916838001178555610b87565b82800160010185558215610b87579182015b82811115610b86578251826000505591602001919060010190610b68565b5b509050610bb29190610b94565b80821115610bae5760008181506000905550600101610b94565b5090565b50506020604051908101604052806000815260200150600c6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610c1657805160ff1916838001178555610c47565b82800160010185558215610c47579182015b82811115610c46578251826000505591602001919060010190610c28565b5b509050610c729190610c54565b80821115610c6e5760008181506000905550600101610c54565b5090565b50506006600060006101000a81548160ff021916908302179055505b565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6004600060009054906101000a900460ff161415610cd357610002565b6005600060006101000a81548160ff0219169083021790555080600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555080600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b50565b600760009054906101000a900460ff1681565b8160096000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610da857805160ff1916838001178555610dd9565b82800160010185558215610dd9579182015b82811115610dd8578251826000505591602001919060010190610dba565b5b509050610e049190610de6565b80821115610e005760008181506000905550600101610de6565b5090565b505080600a6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610e5557805160ff1916838001178555610e86565b82800160010185558215610e86579182015b82811115610e85578251826000505591602001919060010190610e67565b5b509050610eb19190610e93565b80821115610ead5760008181506000905550600101610e93565b5090565b505033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055506001600060006101000a81548160ff021916908302179055507f0717dc3ff38ee55357fb242e706e3116b990ee2e900e4dcdecffea8f3005cb52600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166009600050604051808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252838181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156110245780601f10610ff957610100808354040283529160200191611024565b820191906000526020600020905b81548152906001019060200180831161100757829003601f168201915b505094505050505060405180910390a15b5050565b600060009054906101000a900460ff1681565b600c6000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110e55780601f106110ba576101008083540402835291602001916110e5565b820191906000526020600020905b8154815290600101906020018083116110c857829003601f168201915b505050505081565b6002600060009054906101000a900460ff161415801561111d57506006600060009054906101000a900460ff1614155b1561112757610002565b6003600060006101000a81548160ff0219169083021790555081600b6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061118f57805160ff19168380011785556111c0565b828001600101855582156111c0579182015b828111156111bf5782518260005055916020019190600101906111a1565b5b5090506111eb91906111cd565b808211156111e757600081815060009055506001016111cd565b5090565b505080600c6000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061123c57805160ff191683800117855561126d565b8280016001018555821561126d579182015b8281111561126c57825182600050559160200191906001019061124e565b5b509050611298919061127a565b80821115611294576000818150600090555060010161127a565b5090565b50507fea04ec6e2a3a8ca63f7562feddb67ae3ee02df116a76976b29ce621d89d2a287600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600b600050600c600050604051808473ffffffffffffffffffffffffffffffffffffffff16815260200180602001806020018381038352858181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156113915780601f1061136657610100808354040283529160200191611391565b820191906000526020600020905b81548152906001019060200180831161137457829003601f168201915b50508381038252848181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156114145780601f106113e957610100808354040283529160200191611414565b820191906000526020600020905b8154815290600101906020018083116113f757829003601f168201915b50509550505050505060405180910390a15b5050565b60016000505481565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6003600060009054906101000a900460ff161415801561148957506005600060009054906101000a900460ff1614155b1561149357610002565b3373ffffffffffffffffffffffffffffffffffffffff16600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156114ef57610002565b6004600060006101000a81548160ff0219169083021790555033600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507ffedf826d9b4a1fe2a221dc900337fc72788ddb41c7ae6600c110ca2858365da4600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b565b600a6000508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116695780601f1061163e57610100808354040283529160200191611669565b820191906000526020600020905b81548152906001019060200180831161164c57829003601f168201915b50505050508156', 
			gas: 3000000
		}, function(e, contract){
			console.log(e, contract);
			if (typeof contract.address != 'undefined') {
				console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
				localStorage.setItem("contract", contract.address);
				var contractInstance = carContract.at(contract.address);
				//instance.event.set(contract.address);

			}
		});
}
